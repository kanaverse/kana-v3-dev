!function(){"use strict";var e={9612:function(e,t,n){var r,s,a=n(3324),o=n(7762),c=n(4165),u=n(5861),i=n(2754),l=n(5831),f=n(5137),p=null;function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null===t&&(t=r.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta"));var n=t.getAll();n.onsuccess=function(){var t=n.result;t.forEach((function(e){delete e.files})),e(t)},n.onerror=function(){e(null)}}function h(e,t){return m.apply(this,arguments)}function m(){return(m=(0,u.Z)((0,c.Z)().mark((function e(t,n){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){var r=n.get(t);r.onsuccess=function(){void 0!==r.result?e(r.result):e(null)},r.onerror=function(){e(null)}})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(e){return Promise.allSettled(e).then((function(e){var t,n=(0,o.Z)(e);try{for(n.s();!(t=n.n()).done;){if(!t.value)return!1}}catch(r){n.e(r)}finally{n.f()}return!0}))}function v(){return b.apply(this,arguments)}function b(){return(b=(0,u.Z)((0,c.Z)().mark((function e(){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return e.abrupt("return",new Promise((function(e){d(e)})));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e,t){return _.apply(this,arguments)}function _(){return(_=(0,u.Z)((0,c.Z)().mark((function e(t,n){var s,a,o,u,i,l,f;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return s=r.result.transaction(["file","file_meta"],"readwrite"),a=s.objectStore("file"),o=s.objectStore("file_meta"),e.next=7,h(t,o);case 7:return u=e.sent,i=null===u?0:u.count,i++,l=new Promise((function(e){var r=a.put({id:t,payload:n.buffer});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),f=new Promise((function(e){u.count=i;var t=o.put(u);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}})),e.abrupt("return",y([l,f]));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,t,n,r){return w.apply(this,arguments)}function w(){return(w=(0,u.Z)((0,c.Z)().mark((function e(t,n,s,a){var o,u,i,l,f,h;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:if(o=r.result.transaction(["analysis","analysis_meta"],"readwrite"),u=o.objectStore("analysis"),i=o.objectStore("analysis_meta"),null!=t){e.next=10;break}return e.next=8,new Promise((function(e){return d(e,i)}));case 8:l=e.sent,t=String(l.length);case 10:return f=new Promise((function(e){var r=u.put({id:t,payload:n.buffer});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),h=new Promise((function(e){var n=i.put({id:t,files:s,time:Number(new Date),title:a});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),e.next=14,y([f,h]);case 14:if(!e.sent){e.next=18;break}return e.abrupt("return",t);case 18:return e.abrupt("return",null);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e){return S.apply(this,arguments)}function S(){return(S=(0,u.Z)((0,c.Z)().mark((function e(t){var n,s;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return n=r.result.transaction(["file"],"readonly").objectStore("file"),e.next=5,h(t,n);case 5:return s=e.sent,e.abrupt("return",new Uint8Array(s.payload));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e){return O.apply(this,arguments)}function O(){return(O=(0,u.Z)((0,c.Z)().mark((function e(t){var n,s;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return n=r.result.transaction(["analysis"],"readonly").objectStore("analysis"),e.next=5,h(t,n);case 5:return s=e.sent,e.abrupt("return",new Uint8Array(s.payload));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e){return M.apply(this,arguments)}function M(){return(M=(0,u.Z)((0,c.Z)().mark((function e(t){var n,s,a,o,u,i;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return n=r.result.transaction(["file","file_meta"],"readwrite"),s=n.objectStore("file"),a=n.objectStore("file_meta"),e.next=7,h(t,a);case 7:return o=e.sent,u=o.count,u--,i=[],0==u?(i.push(new Promise((function(e){var n=s.remove(t);n.onerror=function(t){e(!1)},n.onsuccess=function(t){e(!0)}}))),i.push(new Promise((function(e){var n=a.delete(t);n.onerror=function(t){e(!1)},n.onsuccess=function(t){e(!0)}})))):i.push(new Promise((function(e){o.count=u;var t=a.put(o);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}}))),e.abrupt("return",y(i));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function E(){return(E=(0,u.Z)((0,c.Z)().mark((function e(t){var n,s,a,u,i,l,f,d;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p;case 2:return n=r.result.transaction(["analysis","analysis_meta"],"readwrite"),s=n.objectStore("analysis"),a=n.objectStore("analysis_meta"),(u=[]).push(new Promise((function(e){var n=s.delete(t);n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}}))),e.next=9,h(t,a);case 9:i=e.sent,l=(0,o.Z)(i.files);try{for(l.s();!(f=l.n()).done;)d=f.value,u.push(R(d))}catch(c){l.e(c)}finally{l.f()}return u.push(new Promise((function(e){var n=a.delete(t);n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}}))),e.abrupt("return",y(u));case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var j=null;function A(e){return P.apply(this,arguments)}function P(){return P=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,a,o,u,i,l,f,p,d,h,m,y=arguments;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=y.length>1&&void 0!==y[1]?y[1]:null,r=y.length>2&&void 0!==y[2]&&y[2],e.next=4,j;case 4:if(r){e.next=13;break}return a=s.result.transaction(["downloads"],"readonly"),o=a.objectStore("downloads"),u=new Promise((function(e){var n=o.get(t);n.onsuccess=function(t){void 0!==n.result?e(n.result.payload):e(null)},n.onerror=function(t){e(null)}})),e.next=10,u;case 10:if(null===(i=e.sent)){e.next=13;break}return e.abrupt("return",i);case 13:return l=null==n?fetch(t):fetch(t,n),e.next=16,l;case 16:if((f=e.sent).ok){e.next=19;break}throw"failed to download '"+t+"' ("+f.status+")";case 19:return e.next=21,f.arrayBuffer();case 21:return p=e.sent,d=s.result.transaction(["downloads"],"readwrite"),h=d.objectStore("downloads"),m=new Promise((function(e){var n=h.put({url:t,payload:p});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),e.next=27,m;case 27:if(e.sent){e.next=30;break}throw"failed to download resources for '"+t+"'";case 30:return e.abrupt("return",p);case 31:case"end":return e.stop()}}),e)}))),P.apply(this,arguments)}var C=n(8109),D=n(5587),F=n.n(D);n(7462);function T(e,t){if(e)if(Array.isArray(e)){var n,r=(0,o.Z)(e);try{for(r.s();!(n=r.n()).done;){T(n.value,t)}}catch(i){r.e(i)}finally{r.f()}}else if(e.constructor==Object)for(var s=0,c=Object.entries(e);s<c.length;s++){var u=(0,a.Z)(c[s],2);u[0];T(u[1],t)}else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function N(e){postMessage({type:"".concat(e,"_START")})}function B(e,t){if("undefined"==typeof t)postMessage({type:"".concat(e,"_CACHE")});else{var n=[];T(t,n),postMessage({type:"".concat(e,"_DATA"),resp:t},n)}}function V(e,t,n){postMessage({type:"".concat(e,"_ERROR"),resp:{reason:t.toString(),fatal:n}})}function I(e,t,n){for(var r={},s=n.array(),o=0;o<t.length;o++){for(var c={},u=0,i=Object.entries(e);u<i.length;u++){var l=(0,a.Z)(i[u],2),f=l[0],p=l[1];c[f]=p.array().filter((function(e,t){return s[t]==o}))}r[t[o]]=c}return r}function U(e,t){var n,r={},s=(0,o.Z)(t);try{for(s.s();!(n=s.n()).done;){r[n.value]={}}}catch(d){s.e(d)}finally{s.f()}for(var c=0,u=Object.entries(e);c<u.length;c++)for(var i=(0,a.Z)(u[c],2),l=i[0],f=i[1],p=0;p<t.length;p++)r[t[p]][l]=f[p];return r}function z(e,t){return K.apply(this,arguments)}function K(){return(K=(0,u.Z)((0,c.Z)().mark((function e(t,n){var r,s,u,i,l,f,p,d,h,m,y,v,b,x,_,g,w,k,S,Z,O,R,M,E,j,A,P,C,D,F,T,N,B,V,z,K,J,G,H,L,Q,Y,X,q;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t[n].changed){e.next=2;break}return e.abrupt("return",null);case 2:if("inputs"!==n){e.next=13;break}({}),s={},u=(0,o.Z)(t[n].fetchCountMatrix().available());try{for(u.s();!(i=u.n()).done;)l=i.value,s[l]=t[n].fetchCountMatrix().get(l).numberOfRows()}catch(c){u.e(c)}finally{u.f()}for(f={},p=0,d=Object.entries(t[n].fetchFeatureAnnotations());p<d.length;p++){h=(0,a.Z)(d[p],2),m=h[0],y=h[1],v={},b=(0,o.Z)(y.columnNames());try{for(b.s();!(x=b.n()).done;)_=x.value,g=y.column(_),Array.isArray(g)&&(v[_]=g)}catch(c){b.e(c)}finally{b.f()}f[m]=v}return r={num_cells:t[n].fetchCountMatrix().numberOfColumns(),num_genes:s,genes:f,annotations:t[n].fetchCellAnnotations().columnNames()},e.abrupt("return",r);case 13:if("rna_quality_control"!==n){e.next=22;break}return w={},null===(k=t.inputs.fetchBlockLevels())?(k=["default"],w.data={default:{sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().subsetProportions(0)}}):(S={sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().subsetProportions(0)},Z=t.inputs.fetchBlock(),w.data=I(S,k,Z)),O={sums:t[n].fetchFilters().thresholdsSums(),detected:t[n].fetchFilters().thresholdsDetected(),proportion:t[n].fetchFilters().thresholdsSubsetProportions(0)},w.thresholds=U(O,k),e.abrupt("return",w);case 22:if("adt_quality_control"!==n){e.next=32;break}for(R={},null===(k=t.inputs.fetchBlockLevels())?(k=["default"],R.data={default:{sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().subsetTotals(0)}}):(M={sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().maxProportions()},E=t.inputs.fetchBlock(),R.data=I(M,k,E)),j={detected:t[n].fetchFilters().thresholdsDetected(),proportion:t[n].fetchFilters().thresholdsSubsetTotals(0)},R.thresholds=U(j,k),A=0,P=Object.entries(R.thresholds);A<P.length;A++)C=(0,a.Z)(P[A],2),C[0],C[1].sums=NaN;return e.abrupt("return",R);case 32:if("crispr_quality_control"!==n){e.next=41;break}return D={},null===(k=t.inputs.fetchBlockLevels())?(k=["default"],D.data={default:{sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().maxProportions()}}):(F={sums:t[n].fetchMetrics().sums(),detected:t[n].fetchMetrics().detected(),proportion:t[n].fetchMetrics().maxProportions()},T=t.inputs.fetchBlock(),D.data=I(F,k,T)),N={count:t[n].fetchFilters().thresholdsMaxCount(0)},D.thresholds=U(N,k),e.abrupt("return",D);case 41:if("cell_filtering"!==n){e.next=49;break}return B=0,V=null,(z=t[n].fetchDiscards())?(z.forEach((function(e){B+=0==e})),V=z.slice()):(K=t.inputs.hasAvailable(),B=t.inputs.fetchCountMatrix(K[0]).numberOfColumns()),J={retained:B,discard:V},e.abrupt("return",J);case 49:if("rna_normalization"!==n){e.next=53;break}return e.abrupt("return",{});case 53:if("adt_normalization"!==n){e.next=57;break}return e.abrupt("return",{});case 57:if("crispr_normalization"!==n){e.next=61;break}return e.abrupt("return",{});case 61:if("feature_selection"!==n){e.next=66;break}return G={means:t[n].fetchResults().means(),vars:t[n].fetchResults().variances(),fitted:t[n].fetchResults().fitted(),resids:t[n].fetchResults().residuals()},e.abrupt("return",G);case 66:if("rna_pca"!==n&&"adt_pca"!==n&&"crispr_pca"!==n){e.next=74;break}return H=t[n].fetchPCs(),L=H.varianceExplained(),Q=H.totalVariance(),L.forEach((function(e,t){L[t]=e/Q})),e.abrupt("return",{var_exp:L});case 74:if("combine_embeddings"!==n){e.next=78;break}return e.abrupt("return",{});case 78:if("batch_correction"!==n){e.next=82;break}return e.abrupt("return",{});case 82:if("neighbor_index"!==n){e.next=86;break}return e.abrupt("return",{});case 86:if("tsne"!==n&&"umap"!==n){e.next=92;break}return e.next=89,t[n].fetchResults();case 89:case 112:return e.abrupt("return",e.sent);case 92:if("kmeans_cluster"!==n){e.next=96;break}return e.abrupt("return",{});case 96:if("snn_graph_cluster"!==n){e.next=100;break}return e.abrupt("return",{});case 100:if("choose_clustering"!==n){e.next=105;break}return Y=t[n].fetchClusters(),e.abrupt("return",{clusters:Y.slice()});case 105:if("marker_detection"!==n){e.next=109;break}return e.abrupt("return",{});case 109:if("cell_labelling"!==n){e.next=115;break}return e.next=112,t[n].fetchResults();case 115:if("custom_selections"!==n){e.next=119;break}return e.abrupt("return",{});case 119:if("feature_set_enrichment"!==n){e.next=123;break}return X=t.feature_set_enrichment.fetchCollectionDetails(),q=t.feature_set_enrichment.fetchSetDetails(),e.abrupt("return",{collections:X,sets:{names:q.names,descriptions:q.descriptions,sizes:q.sizes.slice(),collections:q.collections.slice()}});case 123:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var J=n(9807);n(3841);var G="K@\ud835\udf02a#$c3ll";var H="".concat(G,"::CLUSTERS"),L="".concat(G,"::SELECTION"),Q=null,Y={},X={},q=null,W={},$="https://cors-proxy.aaron-lun.workers.dev";function ee(e){return te.apply(this,arguments)}function te(){return(te=(0,u.Z)((0,c.Z)().mark((function e(t){var n;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A($+"/"+encodeURIComponent(t));case 2:return n=e.sent,e.abrupt("return",new Uint8Array(n));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ne(e){if("10X"==e.format)return new i.By(e.h5);if("MatrixMarket"==e.format)return new i.en(e.mtx,e.genes||null,e.annotations||null);if("H5AD"==e.format)return new i.Fl(e.h5);if("SummarizedExperiment"==e.format)return new i.H$(e.rds);if("ExperimentHub"==e.format)return new J.M(e.id);throw new Error("unknown format '"+e.format+"'")}function re(e,t){var n,r={},s=(0,o.Z)(e.cells.columnNames());try{for(s.s();!(n=s.n()).done;){var c=n.value;r[c]=i.Qr(e.cells.column(c))}}catch(P){s.e(P)}finally{s.f()}var u={cells:{columns:r,numberOfCells:e.cells.numberOfRows()}};if("H5AD"===t.format){u.all_features={};var l,f={},p=(0,o.Z)(e.all_features.columnNames());try{for(p.s();!(l=p.n()).done;){var d=l.value;f[d]=i.Qr(e.all_features.column(d))}}catch(P){p.e(P)}finally{p.f()}u.all_features={columns:f,numberOfFeatures:e.all_features.numberOfRows()}}else if("SummarizedExperiment"===t.format){if(u.modality_features={},"modality_features"in e)for(var h=0,m=Object.entries(e.modality_features);h<m.length;h++){var y,v=(0,a.Z)(m[h],2),b=v[0],x=v[1],_={},g=(0,o.Z)(x.columnNames());try{for(g.s();!(y=g.n()).done;){var w=y.value;Array.isArray(x.column(w))&&(_[w]=i.Qr(x.column(w)))}}catch(P){g.e(P)}finally{g.f()}u.modality_features[b]={columns:_,numberOfFeatures:x.numberOfRows()}}}else if(u.modality_features={},"modality_features"in e)for(var k=0,S=Object.entries(e.modality_features);k<S.length;k++){var Z,O=(0,a.Z)(S[k],2),R=O[0],M=O[1],E={},j=(0,o.Z)(M.columnNames());try{for(j.s();!(Z=j.n()).done;){var A=Z.value;E[A]=i.Qr(M.column(A))}}catch(P){j.e(P)}finally{j.f()}u.modality_features[R]={columns:E,numberOfFeatures:M.numberOfRows()}}return"H5AD"===t.format?u.all_assay_names=e.all_assay_names:"SummarizedExperiment"===t.format&&(u.modality_assay_names=e.modality_assay_names),u}function se(e){return ae.apply(this,arguments)}function ae(){return(ae=(0,u.Z)((0,c.Z)().mark((function e(t){var n;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,z(Q,t);case 3:(n=e.sent)&&B(t,n),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),V(t,e.t0,!0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function oe(e,t){var n;return e in W||((n=new i.J6(ie(),t.ids.slice())).computeAll(),W[e]=n),W[e]}J.M.setDownloadFun(ee),i.cO.ExperimentHub=J.M,i.ES.setDownload(ee),i.E4.setDownload(ee),f.ao(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t,n,r){var s,a,o;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=f.XZ()+"/"+t,a=$+"/"+encodeURIComponent(s),null!=n||null!=r){e.next=9;break}return e.next=5,A(a);case 5:return o=e.sent,e.abrupt("return",new Response(o));case 9:return e.abrupt("return",fetch(a+"?start="+String(n)+"&end="+String(r)));case 10:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}()),f.d9(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=f.Kk()+"/"+t,e.next=3,A($+"/"+encodeURIComponent(n));case 3:return r=e.sent,e.abrupt("return",new Response(r));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),i.$p((function(e,t,n,r){postMessage({type:e+"_iter",x:t,y:n,iteration:r},[t.buffer,n.buffer])})),i.ED(k);var ce,ue=function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e.startsWith("".concat(G,"::QC::"))){var r=e.replace("".concat(G,"::QC::"),"");t=Q.cell_filtering.fetchFilteredQualityMetric(r.substring(4),r.substring(0,3))}else t=!1!==n?Q.cell_filtering.applyFilter(Q.inputs.fetchCellAnnotations().column(e)):Q.inputs.fetchAnnotations(e);return t},ie=function(){if(null===q){q=new l.VU;for(var e=0,t=Object.entries({RNA:"rna_normalization",ADT:"adt_normalization",CRISPR:"crispr_normalization"});e<t.length;e++){var n=(0,a.Z)(t[e],2),r=n[0],s=n[1],o=Q[s];o.valid()&&q.add(r,o.fetchNormalizedMatrix())}}return q};onmessage=function(e){var t=e.data,n=t.type,o=t.payload;console.log("WORKER::RCV::",n,o);var f=!1;if("INIT"==n){f=!0;var h=Math.round(2*navigator.hardwareConcurrency/3),m=i.j2({numberOfThreads:h}),y=m.then((function(){return i.TN()}));y.then((function(e){Q=e,postMessage({type:n,msg:"Success: analysis state created"})}));var b=p=new Promise((function(e){(r=indexedDB.open("KanaDB",2)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},r.onsuccess=function(){d(e)},r.onerror=function(){e(null)}}));b.then((function(e){null!==e&&postMessage({type:"KanaDB_store",resp:e,msg:"Success: KanaDB initialized"})})).catch((function(e){console.error(e),postMessage({type:"KanaDB_ERROR",msg:"Error: Cannot initialize KanaDB"})}));var _=(null===j&&(j=new Promise((function(e,t){(s=indexedDB.open("DownloadsDB",3)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},s.onsuccess=function(){e(null)},s.onerror=function(){t("failed to initialize DownloadsDB")}}))),j);_.then((function(e){postMessage({type:"DownloadsDB_store",resp:e,msg:"Success: DownloadsDB initialized"})})).catch((function(e){console.error(e),postMessage({type:"DownloadsDB_ERROR",msg:"Error: Cannot initialize DownloadsDB"})}));try{var w=J.M.availableDatasets();postMessage({type:"ExperimentHub_store",resp:w,msg:"Success: ExperimentHub initialized"})}catch(A){postMessage({type:"ExperimentHub_ERROR",msg:"Error: Cannot access datasets in ExperimentHub"})}(ce=Promise.all([m,b,_,y])).then((function(){postMessage({type:n,msg:"Success: bakana initialized"})})).catch((function(e){console.error(e),V(n,e,f)}))}else if("RUN"==n)f=!0,ce.then((function(e){var t=o.inputs,r=t.files;if(null!==r){for(var s={},c=0,u=Object.entries(r);c<u.length;c++){var l=(0,a.Z)(u[c],2),p=l[0],d=l[1];"uid"in d&&d.uid in Y?s[p]=Y[d.uid]:s[p]=ne(d)}for(var h=0,m=Object.entries(Y);h<m.length;h++){var y=(0,a.Z)(m[h],2),v=y[0];y[1].clear(),delete Y[v]}r=s}var b=function(e,t){var n=t,r=function(e,t,r){if("undefined"==typeof r)throw new Error("cannot assign undefined parameter to '"+e+"."+t+"'");if(!(e in n))throw new Error("unknown analysis step '"+e+"'");var s=n[e];if(!(t in s))throw new Error("unknown analysis parameter '"+t+"' for step '"+e+"'");s[t]=r};return r("inputs","block_factor",e.batch),r("inputs","subset",e.subset),i.TD(n,t.batch_correction.method),i.bN(n,t.neighbor_index.approximate),null!==n.combine_embeddings.weights&&new Set([n.combine_embeddings.rna_weight,n.combine_embeddings.adt_weight,n.combine_embeddings.crispr_weight]).size<=1&&(n.combine_embeddings.weights=null),n}(t,o.params);i.x6(Q,r,b,{startFun:N,finishFun:se}).catch((function(e){console.error(e),V(n,e,f)}))})).catch((function(e){console.error(e),V(n,e,f)}));else if("LOAD"==n){f=!0;var S=o.inputs.files;if("kana"==S[Object.keys(S)[0]].format){var O=S[Object.keys(S)[0]].file;ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,a,o,u,l,f;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new FileReaderSync,r=n.readAsArrayBuffer(O),e.next=4,F().loadAsync(r);case 4:return s=e.sent,e.t0=JSON,e.next=8,s.file("config.json").async("string");case 8:e.t1=e.sent,a=e.t0.parse.call(e.t0,e.t1),o={},e.t2=(0,c.Z)().keys(s.files);case 12:if((e.t3=e.t2()).done){e.next=21;break}if(!(u=e.t3.value).startsWith("datasets/")){e.next=19;break}return e.next=17,s.files[u].async("uint8array");case 17:l=e.sent,o[u.split("/")[1]]=l;case 19:e.next=12;break;case 21:return e.next=23,i.j5(a,(function(e){return o[e]}),{state:Q,startFun:N,finishFun:se});case 23:Q=e.sent,f=[],T(a.parameters,f),postMessage({type:"loadedParameters",resp:a.parameters},f);case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}))}else"kanadb"==S[Object.keys(S)[0]].format&&ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,a;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=S[Object.keys(S)[0]].file,e.next=3,Z(n);case 3:return r=e.sent,s=new TextDecoder,a=JSON.parse(s.decode(r)),e.next=8,i.j5(a,k,{state:Q,startFun:N,finishFun:se});case 8:Q=e.sent;case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}))}else if("EXPORT"==n)ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,a,o,u;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],r=function(e,t,r){var s=String(n.length);return n.push(r.buffer()),s},e.next=4,i.JZ(Q,r);case 4:for(s=e.sent,(a=new(F())).file("config.json",JSON.stringify(s)),o=0;o<n.length;o++)a.file("datasets/"+String(o),n[o]);return e.next=10,a.generateAsync({type:"uint8array"});case 10:u=e.sent,postMessage({type:"exportState",resp:u,msg:"Success: application state exported"},[u.buffer]);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}));else if("EXPORT_RDS"==n)ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.lC(Q,"results",{forceBuffer:!0});case 2:return n=e.sent,e.next=5,i.o2(n);case 5:r=e.sent,postMessage({type:"exportRDSState",resp:r,msg:"Success: application state exported"},[r.buffer]);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}));else if("SAVEKDB"==n){var R=o.title;ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var r,s,a,o,l,f,p;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],s=function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t,s,a){var o,u,i;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=a.buffer(),e.next=3,C.FB(o);case 3:return u=e.sent,i=n+"_"+a.name()+"_"+o.length+"_"+u,e.next=7,x(i,o);case 7:if(e.sent){e.next=10;break}throw"failed to save file '"+i+"' to KanaDB";case 10:return r.push(i),e.abrupt("return",i);case 12:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),e.next=4,i.JZ(Q,s);case 4:return a=e.sent,o=new TextEncoder,l=o.encode(JSON.stringify(a)),e.next=9,g(null,l,a,R);case 9:if(null===(f=e.sent)){e.next=17;break}return e.next=13,v();case 13:p=e.sent,postMessage({type:"KanaDB_store",resp:p,msg:"Success: Saved analysis to browser (".concat(f,")")}),e.next=18;break;case 17:postMessage({type:"KanaDB_ERROR",msg:"Fail: Cannot save analysis to browser"});case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}))}else if("REMOVEKDB"==n){var M=o.id;(function(e){return E.apply(this,arguments)})(M).then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,v();case 3:n=e.sent,postMessage({type:"KanaDB_store",resp:n,msg:"Success: Removed file from cache (".concat(M,")")}),e.next=8;break;case 7:postMessage({type:"KanaDB_ERROR",msg:"fail: cannot remove file from cache (".concat(M,")")});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)}))}else"PREFLIGHT_INPUT"==n?ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,u,i,l,f,p,d;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n={},e.prev=1,r={},s={},u=0,i=Object.entries(o.inputs.files);case 5:if(!(u<i.length)){e.next=23;break}if(l=(0,a.Z)(i[u],2),f=l[0],!("uid"in(p=l[1]))){e.next=17;break}if(p.uid in Y){e.next=13;break}return Y[p.uid]=ne(p),e.next=12,Y[p.uid].summary();case 12:X[p.uid]=e.sent;case 13:r[f]=Y[p.uid],s[f]=re(X[p.uid],p),e.next=20;break;case 17:d=ne(p),r[f]=d,s[f]=re(r[f],p);case 20:u++,e.next=5;break;case 23:n.status="SUCCESS",n.details=s,e.next=32;break;case 27:e.prev=27,e.t0=e.catch(1),console.error(e.t0),n.status="ERROR",n.reason=e.t0.toString();case 32:postMessage({type:"PREFLIGHT_INPUT_DATA",resp:n,msg:"Success: PREFLIGHT_INPUT done"});case 33:case"end":return e.stop()}}),e,null,[[1,27]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)})):"computeVersusClusters"==n?ce.then((function(e){var t,n,r=o.rank_type,s=o.modality,a=o.annotation;if(H===a)n=Q.marker_detection.computeVersus(o.left,o.right),t=i.jJ(n.results[s],n.left,r);else{var c=l.Yh(ue(a));n=oe(a,c).computeVersus(c.levels.indexOf(o.left),c.levels.indexOf(o.right)),t=i.jJ(n.results[s],n.left,r)}var u=[];T(t,u),postMessage({type:"computeVersusClusters",resp:t,msg:"Success: COMPUTE_VERSUS_CLUSTERS done"},u)})).catch((function(e){console.error(e),V(n,e,f)})):"computeVersusSelections"==n?ce.then((function(e){var t=o.rank_type,n=Q.custom_selections.computeVersus(o.left,o.right),r=i.jJ(n.results[o.modality],o.left,t),s=[];T(r,s),postMessage({type:"computeVersusSelections",resp:r,msg:"Success: COMPUTE_VERSUS_SELECTIONS done"},s)})).catch((function(e){console.error(e),V(n,e,f)})):"getMarkersForCluster"==n?ce.then((function(e){var t,n,r=o.cluster,s=o.rank_type,a=o.modality,c=o.annotation;if(H===c)n=Q.marker_detection.fetchResults()[a],t=i.jJ(n,r,s);else{var u=l.Yh(ue(c));n=oe(c,u).fetchResults()[a],t=i.jJ(n,u.levels.indexOf(r),s)}var f=[];T(t,f),postMessage({type:"setMarkersForCluster",resp:t,msg:"Success: GET_MARKER_GENE done"},f)})).catch((function(e){console.error(e),V(n,e,f)})):"getGeneExpression"==n?ce.then((function(e){var t,n=o.gene,r=o.modality,s=ie(r);if("RNA"===r)t=s.get(r).row(n);else if("ADT"===r)t=s.get(r).row(n);else{if("CRISPR"!==r)throw new Error("unknown feature type '"+r+"'");t=s.get(r).row(n)}postMessage({type:"setGeneExpression",resp:{gene:n,expr:t},msg:"Success: GET_GENE_EXPRESSION done"},[t.buffer])})).catch((function(e){console.error(e),V(n,e,f)})):"computeCustomMarkers"==n?ce.then((function(e){Q.custom_selections.addSelection(o.id,o.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})).catch((function(e){console.error(e),V(n,e,f)})):"getMarkersForSelection"==n?ce.then((function(e){var t=Q.custom_selections.fetchResults(o.cluster)[o.modality],n=i.jJ(t,o.cluster,o.rank_type),r=[];T(n,r),postMessage({type:"setMarkersForCustomSelection",resp:n,msg:"Success: GET_MARKER_GENE done"},r)})).catch((function(e){console.error(e),V(n,e,f)})):"removeCustomMarkers"==n?ce.then((function(e){Q.custom_selections.removeSelection(o.id)})).catch((function(e){console.error(e),V(n,e,f)})):"animateTSNE"==n?ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Q.tsne.animate();case 2:return e.t0=B,e.next=5,Q.tsne.fetchResults();case 5:e.t1=e.sent,(0,e.t0)("tsne",e.t1);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)})):"animateUMAP"==n?ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Q.umap.animate();case 2:return e.t0=B,e.next=5,Q.umap.fetchResults();case 5:e.t1=e.sent,(0,e.t0)("umap",e.t1);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)})):"getAnnotation"==n?ce.then((function(e){var t,n,r=o.annotation;if(t=ue(r,o.unfiltered),ArrayBuffer.isView(t))n={type:"array",values:t.slice()};else{var s=[],a={},c=new Int32Array(t.length);t.map((function(e,t){e in a||(a[e]=s.length,s.push(e)),c[t]=a[e]})),n={type:"factor",index:c,levels:s}}var u=[];T(n,u),postMessage({type:"setAnnotation",resp:{annotation:r,values:n},msg:"Success: GET_ANNOTATION done"},u)})).catch((function(e){console.error(e),V(n,e,f)})):"computeFeaturesetSummary"==n?ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,a,u,i,f,p,d,h,m,y,v;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=o.annotation,r=o.rank_type,s=o.cluster,a=r.indexOf("-"),H===n?B("computeFeaturesetSummary",Q.feature_set_enrichment.computeEnrichment(Q.marker_detection.fetchResults().RNA,s,r.slice(0,a),r.slice(a+1))):L===n?(u=Q.custom_selections.fetchSelectionIndices(s),i=Q.cell_filtering.fetchFilteredMatrix().numberOfColumns(),f=new Uint8Array(i),u.map((function(e){return f.set([1],e)})),p=l.Yh(f),d=oe(n,p),h=d.fetchResults().RNA,B("computeFeaturesetSummary",Q.feature_set_enrichment.computeEnrichment(h,p.levels.indexOf(1),r.slice(0,a),r.slice(a+1)))):(m=l.Yh(ue(n)),y=oe(n,m),v=y.fetchResults().RNA,B("computeFeaturesetSummary",Q.feature_set_enrichment.computeEnrichment(v,m.levels.indexOf(s),r.slice(0,a),r.slice(a+1))));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)})):"computeFeaturesetVSSummary"==n?ce.then(function(){var e=(0,u.Z)((0,c.Z)().mark((function e(t){var n,r,s,a,u,i,f,p,d,h;return(0,c.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=o.annotation,r=o.rank_type,s=o.left,a=o.right,u=r.indexOf("-"),H===n?(i=Q.marker_detection.computeVersus(s,a),B("computeFeaturesetVSSummary",Q.feature_set_enrichment.computeEnrichment(i.results.RNA,i.left,r.slice(0,u),r.slice(u+1)))):L===n?(f=Q.custom_selections.computeVersus(s,a),B("computeFeaturesetVSSummary",Q.feature_set_enrichment.computeEnrichment(f.results.RNA,0,r.slice(0,u),r.slice(u+1)))):(p=l.Yh(ue(n)),d=oe(n,p),h=d.computeVersus(p.levels.indexOf(o.left),p.levels.indexOf(o.right)),B("computeFeaturesetVSSummary",Q.feature_set_enrichment.computeEnrichment(h.results.RNA,h.left,r.slice(0,u),r.slice(u+1))));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),V(n,e,f)})):"getFeatureScores"===n?ce.then((function(e){var t=o.index;B("setFeatureScores",Q.feature_set_enrichment.computePerCellScores(t))})).catch((function(e){console.error(e),V(n,e,f)})):"getFeatureGeneIndices"===n?ce.then((function(e){var t,n,r=o.index,s=o.cluster,c=o.annotation,u=o.modality,f=o.rank_type,p=Q.feature_set_enrichment.fetchFeatureSetIndices(r);if(H===c)t=Q.marker_detection.fetchResults()[u],n=i.jJ(t,s,f);else if(L===c)t=Q.custom_selections.fetchResults(o.cluster)[o.modality],n=i.jJ(t,o.cluster,o.rank_type);else{var d=l.Yh(ue(c));t=oe(c,d).fetchResults()[u],n=i.jJ(t,d.levels.indexOf(s),f)}for(var h=n.ordering.map((function(e,t){return p.includes(e)?t:-100})).filter((function(e){return-100!==e})),m={},y=0,v=Object.entries(n);y<v.length;y++){var b=(0,a.Z)(v[y],2),x=b[0],_=b[1];m[x]=_.map((function(e,t){return h.includes(t)?e:-100})).filter((function(e){return-100!==e}))}B("setFeatureGeneIndices",m)})).catch((function(e){console.error(e),V(n,e,f)})):V(n,"Type: ".concat(n," not defined"),f)}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var a=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}n.m=e,n.x=function(){var e=n.O(void 0,[319,551,776],(function(){return n(9612)}));return e=n.O(e)},function(){var e=[];n.O=function(t,r,s,a){if(!r){var o=1/0;for(l=0;l<e.length;l++){r=e[l][0],s=e[l][1],a=e[l][2];for(var c=!0,u=0;u<r.length;u++)(!1&a||o>=a)&&Object.keys(n.O).every((function(e){return n.O[e](r[u])}))?r.splice(u--,1):(c=!1,a<o&&(o=a));if(c){e.splice(l--,1);var i=s();void 0!==i&&(t=i)}}return t}a=a||0;for(var l=e.length;l>0&&e[l-1][2]>a;l--)e[l]=e[l-1];e[l]=[r,s,a]}}(),n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce((function(t,r){return n.f[r](e,t),t}),[]))},n.u=function(e){return"static/js/"+e+"."+{319:"0c72d2be",484:"ebd432e3",551:"8e5084b5",776:"06e8cffa",909:"e5ca9c2a",933:"4ecc3de1"}[e]+".chunk.js"},n.miniCssF=function(e){},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e},n.p="/kana-v3-dev/",function(){n.b=self.location+"/../../../";var e={612:1};n.f.i=function(t,r){e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],r=t.push.bind(t);t.push=function(t){var s=t[0],a=t[1],o=t[2];for(var c in a)n.o(a,c)&&(n.m[c]=a[c]);for(o&&o(n);s.length;)e[s.pop()]=1;r(t)}}(),function(){var e=n.x;n.x=function(){return Promise.all([319,551,776].map(n.e,n)).then(e)}}();n.x()}();
//# sourceMappingURL=612.c00bcdeb.chunk.js.map